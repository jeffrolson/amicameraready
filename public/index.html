<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Am I Camera Ready?</title>
  <meta name="description" content="Preview your on-camera look and background. No recording. Runs in your browser." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
    rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            display: ['"Plus Jakarta Sans"', 'ui-sans-serif', 'system-ui'],
          },
          colors: {
            midnight: '#020617',
            iris: {
              100: '#e0e7ff',
              400: '#6366f1',
              500: '#4f46e5',
              600: '#4338ca',
            },
            aqua: {
              100: '#cffafe',
              500: '#06b6d4',
            },
          },
        },
      },
    };
  </script>
  <style>
    :root {
      color-scheme: dark;
    }

    body {
      font-family: "Plus Jakarta Sans", ui-sans-serif, system-ui;
      background: radial-gradient(circle at top left, rgba(14, 165, 233, 0.18), transparent 55%),
        radial-gradient(circle at 80% 0%, rgba(124, 58, 237, 0.18), transparent 45%),
        radial-gradient(circle at 50% 85%, rgba(236, 72, 153, 0.14), transparent 55%),
        #020617;
      min-height: 100vh;
    }

    .hero-card {
      backdrop-filter: blur(22px);
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.85), rgba(30, 41, 59, 0.7));
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: 0 40px 80px -60px rgba(79, 70, 229, 0.6);
    }

    .primary-btn {
      background: linear-gradient(130deg, rgba(56, 189, 248, 0.95), rgba(99, 102, 241, 0.95));
      transition: transform 0.18s ease, box-shadow 0.18s ease;
      box-shadow: 0 25px 45px -30px rgba(99, 102, 241, 0.8);
    }

    .primary-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 35px 55px -30px rgba(56, 189, 248, 0.9);
    }

    .control-pill {
      border: 1px solid transparent;
      transition: background-color 0.15s ease, border-color 0.15s ease, box-shadow 0.2s ease;
    }

    .control-pill.active {
      border-color: rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.55);
      box-shadow: 0 10px 25px -16px rgba(148, 163, 184, 0.55);
    }

    .mirror {
      transform: scaleX(-1);
    }

    .controls-disabled {
      opacity: 0.55;
      pointer-events: none;
    }

    .video-scale {
      transform-origin: center center;
      transition: transform 0.18s ease;
    }

    .grid-overlay {
      pointer-events: none;
      background-image:
        linear-gradient(to right, rgba(255, 255, 255, .12) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255, 255, 255, .12) 1px, transparent 1px);
      background-size: calc(100% / 3) 100%, 100% calc(100% / 3);
    }

    .side-marker {
      transition: opacity .3s ease;
    }

    .side-marker.hidden-soft {
      opacity: 0;
      pointer-events: none;
    }

    .stage-shell {
      position: fixed;
      inset: 0;
      display: none;
      z-index: 30;
      background: radial-gradient(circle at 20% 20%, rgba(148, 163, 184, 0.16), transparent 60%),
        radial-gradient(circle at 80% 0%, rgba(59, 130, 246, 0.18), transparent 50%),
        rgba(2, 6, 23, 0.95);
    }

    .stage-shell.visible {
      display: block;
    }

    .stage-shell video {
      filter: saturate(1.1) contrast(1.05);
    }

    .floating-controls {
      background: rgba(15, 23, 42, 0.55);
      border: 1px solid rgba(148, 163, 184, 0.35);
      backdrop-filter: blur(12px);
      box-shadow: 0 20px 50px -28px rgba(15, 23, 42, 0.75);
    }

    body.is-stage-open #siteHeader {
      position: fixed;
      inset: 0 auto auto 0;
      width: 100%;
      z-index: 40;
      pointer-events: none;
    }

    body.is-stage-open #siteHeader .header-inner {
      pointer-events: auto;
      margin-top: 1.75rem;
      background: none;
      border: none;
      padding: 0 1.5rem;
    }

    body.is-stage-open #siteHeader nav {
      background: rgba(15, 23, 42, 0.55);
      border-color: rgba(148, 163, 184, 0.35);
      backdrop-filter: blur(14px);
      box-shadow: 0 20px 45px -25px rgba(15, 23, 42, 0.7);
    }

    body.is-stage-open main {
      filter: blur(12px);
      pointer-events: none;
      user-select: none;
    }

    @media (max-width: 768px) {
      body.is-stage-open #siteHeader .header-inner {
        padding: 0 1rem;
      }
    }

    /* Feedback Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      z-index: 50;
      background: rgba(2, 6, 23, 0.8);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .modal-backdrop.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .modal-card {
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      border-radius: 24px;
      width: 90%;
      max-width: 500px;
      padding: 2rem;
      transform: scale(0.95);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .modal-backdrop.visible .modal-card {
      transform: scale(1);
    }

    .option-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      padding: 1rem;
      border-radius: 1rem;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.2s ease;
    }

    .option-btn:hover,
    .option-btn.selected {
      background: rgba(56, 189, 248, 0.1);
      border-color: rgba(56, 189, 248, 0.5);
      transform: translateY(-2px);
    }

    .option-btn.selected {
      box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.5);
    }

    .countdown-overlay {
      position: fixed;
      inset: 0;
      z-index: 60;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.3);
      font-size: 10rem;
      font-weight: 800;
      color: white;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .flash-overlay {
      position: fixed;
      inset: 0;
      z-index: 70;
      background: white;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.5s ease-out;
    }
  </style>
</head>

<body class="min-h-screen text-slate-100 antialiased">
  <div class="pointer-events-none fixed inset-0 overflow-hidden">
    <div class="absolute -left-16 top-10 h-72 w-72 rounded-full bg-cyan-400/10 blur-3xl"></div>
    <div class="absolute bottom-10 right-0 h-96 w-96 rounded-full bg-indigo-500/10 blur-3xl"></div>
  </div>

  <header id="siteHeader" class="relative">
    <div
      class="header-inner mx-auto flex max-w-6xl flex-wrap items-center justify-between gap-4 px-6 py-6 transition-all duration-300">
      <div class="flex items-center gap-3 rounded-2xl border border-white/10 bg-white/5 px-4 py-2 backdrop-blur">
        <span
          class="flex h-11 w-11 items-center justify-center rounded-xl bg-gradient-to-br from-sky-500/30 to-indigo-500/40">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" class="h-6 w-6 text-cyan-200">
            <path fill="currentColor"
              d="M10.5 6A4.5 4.5 0 0 0 6 10.5v11A4.5 4.5 0 0 0 10.5 26h11a4.5 4.5 0 0 0 4.5-4.5v-11A4.5 4.5 0 0 0 21.5 6zM10 10h12a2 2 0 0 1 2 2v8l-3-2h-8l-3 2v-8a2 2 0 0 1 2-2Z" />
          </svg>
        </span>
        <div>
          <p class="text-[11px] uppercase tracking-[0.38em] text-slate-300">Camera Toolkit</p>
          <h1 class="text-xl font-semibold md:text-2xl">Am I Camera Ready?</h1>
        </div>
      </div>
      <nav id="controlBar"
        class="controls-disabled flex items-center gap-2 rounded-full border border-white/10 bg-white/10 p-1 backdrop-blur transition-all duration-300">
        <button id="toggleReverse"
          class="control-pill rounded-full px-4 py-2 text-sm font-medium text-white/90 hover:bg-white/20">Reverse</button>
        <button id="toggleGrid"
          class="control-pill rounded-full px-4 py-2 text-sm font-medium text-white/90 hover:bg-white/20">Grid</button>
        <button id="feedbackBtn"
          class="control-pill rounded-full px-4 py-2 text-sm font-medium text-sky-200 hover:bg-sky-500/20 border-sky-500/30">Feedback</button>
        <button id="stopBtn"
          class="control-pill rounded-full px-4 py-2 text-sm font-medium text-rose-100 hover:bg-rose-400/20">Stop</button>
      </nav>
    </div>
  </header>

  <main class="relative z-10">
    <section class="relative flex min-h-[78vh] items-center justify-center px-6 py-14">
      <div
        class="hero-card relative mx-auto grid w-full max-w-6xl items-center gap-10 overflow-hidden rounded-[32px] px-8 py-12 md:grid-cols-[1.1fr_0.9fr] md:px-12">
        <div class="space-y-6">
          <span
            class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-4 py-1 text-xs uppercase tracking-[0.28em] text-slate-300">Private
            · Realtime · HD</span>
          <h2 class="text-4xl font-semibold leading-tight text-white md:text-5xl">Preview your video presence before
            every call.</h2>
          <p class="max-w-xl text-base text-slate-200/90 md:text-lg">Launch a distraction-free stage to fine-tune
            framing, lighting, and background. Everything stays on your device—no uploads, no storage, just instant
            feedback.</p>
          <div class="flex flex-wrap items-center gap-5">
            <button id="continueBtn"
              class="primary-btn inline-flex items-center gap-2 rounded-full px-8 py-3 text-base font-semibold text-white">
              <span>Open Camera Preview</span>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="1.5" class="h-5 w-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12h15m0 0-6-6m6 6-6 6" />
              </svg>
            </button>
            <div class="flex items-center gap-3 text-xs text-slate-300/90">
              <div class="flex -space-x-2">
                <span
                  class="inline-flex h-8 w-8 items-center justify-center rounded-full border border-white/15 bg-white/10 text-[11px]">4K</span>
                <span
                  class="inline-flex h-8 w-8 items-center justify-center rounded-full border border-white/15 bg-white/10 text-[11px]">HD</span>
                <span
                  class="inline-flex h-8 w-8 items-center justify-center rounded-full border border-white/15 bg-white/10 text-[11px]">SD</span>
              </div>
              <span>Optimized for every resolution</span>
            </div>
          </div>
        </div>
        <div class="relative">
          <div
            class="absolute -inset-10 rounded-[48px] bg-gradient-to-br from-sky-500/25 via-transparent to-purple-500/25 blur-3xl">
          </div>
          <div class="relative overflow-hidden rounded-[32px] border border-white/10 bg-slate-950/60 shadow-2xl">
            <div
              class="flex items-center justify-center bg-gradient-to-br from-slate-900 via-slate-950 to-slate-900 px-6 py-10">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 120" class="h-44 w-full text-indigo-300/70">
                <defs>
                  <linearGradient id="frameGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="rgba(56,189,248,0.65)" />
                    <stop offset="50%" stop-color="rgba(129,140,248,0.65)" />
                    <stop offset="100%" stop-color="rgba(236,72,153,0.65)" />
                  </linearGradient>
                </defs>
                <rect x="16" y="16" width="168" height="88" rx="16" fill="none" stroke="url(#frameGradient)"
                  stroke-width="3" />
                <path d="M52 32h96v56H52z" fill="none" stroke="rgba(99,102,241,0.45)" stroke-width="2"
                  stroke-dasharray="6 8" />
                <circle cx="100" cy="60" r="18" stroke="rgba(99,102,241,0.45)" fill="none" stroke-width="2" />
                <circle cx="100" cy="60" r="4" fill="rgba(56,189,248,0.7)" />
                <path d="M100 24v8m0 56v8m60-36h-8m-104 0H40" stroke="rgba(99,102,241,0.45)" stroke-width="2"
                  stroke-linecap="round" />
              </svg>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="px-6 pb-16 md:px-10">
      <div class="mx-auto grid max-w-6xl gap-6 md:grid-cols-4">
        <article class="rounded-2xl border border-white/10 bg-white/5 p-6 backdrop-blur">
          <p class="text-xs uppercase tracking-[0.3em] text-slate-300">Framing</p>
          <h3 class="mt-3 text-lg font-semibold">Level your shot</h3>
          <p class="mt-3 text-sm text-slate-200/90">Raise the camera to eye level and leave a touch of headroom. Align
            your eyes with the top grid line.</p>
        </article>
        <article class="rounded-2xl border border-white/10 bg-white/5 p-6 backdrop-blur">
          <p class="text-xs uppercase tracking-[0.3em] text-slate-300">Lighting</p>
          <h3 class="mt-3 text-lg font-semibold">Face the light</h3>
          <p class="mt-3 text-sm text-slate-200/90">Use a soft source in front of you to eliminate shadows. Avoid bright
            lights directly behind you.</p>
        </article>
        <article class="rounded-2xl border border-white/10 bg-white/5 p-6 backdrop-blur">
          <p class="text-xs uppercase tracking-[0.3em] text-slate-300">Background</p>
          <h3 class="mt-3 text-lg font-semibold">Curate the scene</h3>
          <p class="mt-3 text-sm text-slate-200/90">Remove distractions and choose contrasting colors so you stand out
            crisply on camera.</p>
        </article>
        <article class="rounded-2xl border border-white/10 bg-white/5 p-6 backdrop-blur">
          <p class="text-xs uppercase tracking-[0.3em] text-slate-300">Audio</p>
          <h3 class="mt-3 text-lg font-semibold">Check your mic</h3>
          <p class="mt-3 text-sm text-slate-200/90">Use headphones or a dedicated microphone to eliminate echo and keep
            your voice sharp.</p>
        </article>
      </div>
      <footer class="mt-12 text-center text-xs text-slate-400">No data leaves your device. Close the page or press Stop
        to instantly end camera access.</footer>
    </section>
  </main>

  <section id="stageSection" class="stage-shell">
    <div class="relative flex h-full w-full items-center justify-center">
      <div class="absolute inset-0 overflow-hidden">
        <div id="videoInner" class="video-scale absolute inset-0">
          <video id="video" playsinline autoplay muted class="h-full w-full object-cover"></video>
        </div>
        <div id="grid" class="absolute inset-0 opacity-0 transition-opacity grid-overlay"></div>
      </div>

      <span id="labelLeft"
        class="side-marker hidden-soft absolute top-1/2 left-4 -translate-y-1/2 rounded-lg bg-slate-900/55 px-3 py-1 text-xs font-medium uppercase tracking-wide text-white shadow">
        Left
      </span>
      <span id="labelRight"
        class="side-marker hidden-soft absolute top-1/2 right-4 -translate-y-1/2 rounded-lg bg-slate-900/55 px-3 py-1 text-xs font-medium uppercase tracking-wide text-white shadow">
        Right
      </span>

      <div
        class="floating-controls absolute bottom-6 right-6 flex items-center gap-2 rounded-full px-4 py-2 text-slate-100">
        <button id="zoomOut" aria-label="Zoom out"
          class="h-9 w-9 rounded-full border border-white/15 bg-white/5 text-lg leading-none hover:bg-white/10">−</button>
        <button id="zoomIn" aria-label="Zoom in"
          class="h-9 w-9 rounded-full border border-white/15 bg-white/5 text-lg leading-none hover:bg-white/10">+</button>
        <span id="zoomValue"
          class="rounded-full border border-white/15 bg-white/5 px-3 py-1 text-xs font-medium uppercase tracking-wide">1.00x</span>
      </div>
    </div>
  </section>

  <script>
    const continueBtn = document.getElementById("continueBtn");
    const stageSection = document.getElementById("stageSection");
    const videoEl = document.getElementById("video");
    const videoInner = document.getElementById("videoInner");
    const gridEl = document.getElementById("grid");
    const toggleReverseBtn = document.getElementById("toggleReverse");
    const toggleGridBtn = document.getElementById("toggleGrid");
    const stopBtn = document.getElementById("stopBtn");
    const zoomInBtn = document.getElementById("zoomIn");
    const zoomOutBtn = document.getElementById("zoomOut");
    const zoomValue = document.getElementById("zoomValue");
    const labelLeft = document.getElementById("labelLeft");
    const labelRight = document.getElementById("labelRight");
    const controlBar = document.getElementById("controlBar");

    // Feedback UI
    const feedbackBtn = document.getElementById("feedbackBtn");
    const feedbackModal = document.getElementById("feedbackModal");
    const cancelFeedback = document.getElementById("cancelFeedback");
    const startAnalysis = document.getElementById("startAnalysis");
    const closeFeedback = document.getElementById("closeFeedback");
    const feedbackStep1 = document.getElementById("feedbackStep1");
    const feedbackStep2 = document.getElementById("feedbackStep2");
    const feedbackStep3 = document.getElementById("feedbackStep3");
    const feedbackResult = document.getElementById("feedbackResult");
    const optionBtns = document.querySelectorAll(".option-btn");
    const countdownEl = document.getElementById("countdown");
    const flashEl = document.getElementById("flash");

    let stream = null;
    let mirrored = true;
    let gridOn = false;
    let zoom = 1;
    let hideTimer = null;
    let selectedFeedbackType = "professional";

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
        videoEl.srcObject = stream;
        await videoEl.play();
        stageSection.classList.add("visible");
        document.body.classList.add("is-stage-open");
        controlBar.classList.remove("controls-disabled");
        videoEl.classList.toggle("mirror", mirrored);
        toggleReverseBtn.classList.toggle("active", mirrored);
        applyZoom();
        updateLabels(true);
      } catch (err) {
        console.error("Unable to access camera", err);
      }
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      gridOn = false;
      toggleGridBtn.classList.remove("active");
      gridEl.style.opacity = "0";
      mirrored = true;
      videoEl.classList.add("mirror");
      toggleReverseBtn.classList.add("active");
      hideLabels();
      stageSection.classList.remove("visible");
      document.body.classList.remove("is-stage-open");
      controlBar.classList.add("controls-disabled");
    }

    function applyZoom() {
      videoInner.style.transform = `scale(${zoom})`;
      zoomValue.textContent = `${zoom.toFixed(2)}x`;
    }

    function setZoom(value) {
      zoom = Math.min(3, Math.max(1, value));
      applyZoom();
    }

    function updateLabels(show = false) {
      if (mirrored) {
        labelLeft.textContent = "Left";
        labelRight.textContent = "Right";
        labelLeft.style.left = "1rem";
        labelLeft.style.right = "";
        labelRight.style.right = "1rem";
        labelRight.style.left = "";
      } else {
        labelLeft.textContent = "Left";
        labelRight.textContent = "Right";
        labelLeft.style.right = "1rem";
        labelLeft.style.left = "";
        labelRight.style.left = "1rem";
        labelRight.style.right = "";
      }
      if (show) showLabelsTemporarily();
    }

    function showLabelsTemporarily() {
      clearTimeout(hideTimer);
      labelLeft.classList.remove("hidden-soft");
      labelRight.classList.remove("hidden-soft");
      hideTimer = setTimeout(hideLabels, 2200);
    }

    function hideLabels() {
      labelLeft.classList.add("hidden-soft");
      labelRight.classList.add("hidden-soft");
    }

    continueBtn.addEventListener("click", startCamera);
    stopBtn.addEventListener("click", stopCamera);

    toggleReverseBtn.addEventListener("click", () => {
      mirrored = !mirrored;
      videoEl.classList.toggle("mirror", mirrored);
      toggleReverseBtn.classList.toggle("active", mirrored);
      updateLabels(true);
    });

    toggleGridBtn.addEventListener("click", () => {
      gridOn = !gridOn;
      gridEl.style.opacity = gridOn ? "1" : "0";
      toggleGridBtn.classList.toggle("active", gridOn);
    });

    zoomInBtn.addEventListener("click", () => setZoom(zoom + 0.1));
    zoomOutBtn.addEventListener("click", () => setZoom(zoom - 0.1));

    stageSection.addEventListener("wheel", event => {
      if (!stageSection.classList.contains("visible")) return;
      event.preventDefault();
      const delta = Math.sign(event.deltaY) < 0 ? 0.08 : -0.08;
      setZoom(zoom + delta);
    }, { passive: false });

    // Feedback Logic
    feedbackBtn.addEventListener("click", () => {
      feedbackModal.classList.add("visible");
      resetFeedbackModal();
    });

    cancelFeedback.addEventListener("click", () => {
      feedbackModal.classList.remove("visible");
    });

    closeFeedback.addEventListener("click", () => {
      feedbackModal.classList.remove("visible");
    });

    optionBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        optionBtns.forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        selectedFeedbackType = btn.dataset.type;
      });
    });

    startAnalysis.addEventListener("click", async () => {
      feedbackModal.classList.remove("visible");
      await runCountdown();
      const imageBase64 = captureFrame();
      flashEffect();

      // Show loading state
      feedbackModal.classList.add("visible");
      feedbackStep1.classList.add("hidden");
      feedbackStep2.classList.remove("hidden");

      try {
        const result = await sendToGemini(imageBase64, selectedFeedbackType);
        feedbackResult.innerHTML = formatResult(result);
        feedbackStep2.classList.add("hidden");
        feedbackStep3.classList.remove("hidden");
      } catch (err) {
        feedbackResult.textContent = "Error analyzing image. Please try again.";
        feedbackStep2.classList.add("hidden");
        feedbackStep3.classList.remove("hidden");
        console.error(err);
      }
    });

    function resetFeedbackModal() {
      feedbackStep1.classList.remove("hidden");
      feedbackStep2.classList.add("hidden");
      feedbackStep3.classList.add("hidden");
      feedbackResult.textContent = "";
    }

    function runCountdown() {
      return new Promise(resolve => {
        let count = 3;
        countdownEl.textContent = count;
        countdownEl.style.opacity = "1";

        const interval = setInterval(() => {
          count--;
          if (count > 0) {
            countdownEl.textContent = count;
          } else {
            clearInterval(interval);
            countdownEl.style.opacity = "0";
            resolve();
          }
        }, 1000);
      });
    }

    function flashEffect() {
      flashEl.style.opacity = "0.8";
      setTimeout(() => flashEl.style.opacity = "0", 150);
    }

    function captureFrame() {
      const canvas = document.createElement("canvas");
      canvas.width = videoEl.videoWidth;
      canvas.height = videoEl.videoHeight;
      const ctx = canvas.getContext("2d");

      // Handle mirroring if needed
      if (!mirrored) { // Note: 'mirrored' var means CSS mirror is active. 
        // Actually, if CSS mirror is active, we might want to flip the canvas too 
        // so the AI sees what the user sees? 
        // Usually AI wants the raw image, but let's send what the user sees.
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
      }

      ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);
      return canvas.toDataURL("image/jpeg", 0.8).split(",")[1]; // Return base64 only
    }

    async function sendToGemini(image, type) {
      const response = await fetch("/api/analyze", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ image, type })
      });
      if (!response.ok) throw new Error("API Error");
      return await response.text();
    }

    function formatResult(text) {
      // Simple markdown-to-html converter for basic lists/bold
      return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
    }

    window.addEventListener("beforeunload", () => {
      if (stream) stream.getTracks().forEach(track => track.stop());
    });
  </script>
</body>

</html>